<?xml version="1.0"?>
<?xml-stylesheet href="chrome://global/skin/" type="text/css"?>

<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
		xmlns:h="http://www.w3.org/1999/xhtml"
		title="smart-text options :)"
		onload="Init();"
		onunload='saveChanges()'
		centerscreen='true'
		>
		 <h:head><h:link rel="icon" href="chrome://smarttext/content/icon.png"/></h:head>

<prefpane id="locationbar2">
<hbox>
	<button flex='1' onclick="reloadWin()">reload</button>
	<button flex='1' onclick="reset=true;applyStyleSheet();resetVals()">reset</button>
</hbox>
<grid tooltiptext="configure appearence of urlbar">
<columns>
	<column flex="1"/>
	<column flex="0"/>
	<column flex="0"/>
</columns>
<rows flex="1" >
	<row align="center">
		<label>font size</label>
		<textbox id="font-size" type="number" value="12" oncommand="applyStyleSheet()" onkeyup1='applyStyleSheet()'/><label>px</label>
	</row>
	<row align="center">
		<label>urlbar height</label>
		<textbox id="bar-height" type="number" value="24" oncommand="applyStyleSheet()"/><label>px</label>
	</row>
	<row align="center">
		<label>hide identity icon label</label>
		<checkbox id="annoyance" oncommand="applyStyleSheet()"/><label> </label>
	</row>
	<row align="center">
		<label>fission background</label>
		<checkbox id="fission" oncommand="applyStyleSheet()"/><label> </label>
	</row>
	
</rows >
</grid>
	
	

<panel id="alertpanel">
	<vbox>
		<label id="alert-p-title"/>			
		<label multiline="true" id="alert-p-text"/>
		<hbox style="display:none">
			<button label="copy" id="alert-p-1"></button>
			<button label="selectAll" id="alert-p-2"></button>
		</hbox>
	</vbox>
</panel>
<groupbox  align='stretch' id='stylish' style='display:none'>
 <caption label="stylish mode"/>
	<vbox flex='1'>
		<button id="" label="don't use stylish" oncommand="switchtoNormal()"/>	
<textbox multiline="true" class="plain" style='min-height:70px'
value="when uninstalling this extension uninstall 'style for smart-text' style as well"
/>
	</vbox>	
</groupbox>
<groupbox  align='stretch' id='normal'>
 <caption label=""/>
	<vbox flex='1'>
		<button id="switch-to-stylish" label="switch to stylish mode" oncommand="switchtoStylish()"/>
<textbox multiline="true" class="plain" style='min-height:70px'
value="some features work better with stylish style installed.
 the button above creates style named 'style for smart-text' 
when uninstalling this extension uninstall that style as well"
/>
	</vbox>	
</groupbox>



<hbox>
<spacer flex="10"/><button label="save" oncommand="window.close()"/>
</hbox>
</prefpane>

<script type="application/x-javascript">
  <![CDATA[	
	
var winService = Components.classes["@mozilla.org/appshell/window-mediator;1"].getService(Components.interfaces.nsIWindowMediator);
var styleURI="chrome://smarttext/content/options.xul";
var aWin,stylishService
gChange=false
/**smart text specific*/
function Init() {
	var fWins = winService.getEnumerator('navigator:browser');
	if(fWins.hasMoreElements()) {			
		aWin=fWins.getNext()			
	}else{
		var bu=document.createElement("button")
		bu.setAttribute("onclick","Init()")
		bu.setAttribute("label","no browser windows detected, try opening one")
		document.documentElement.appendChild(bu)
		return;
	}
	try{
		stylishService=aWin.stylishOverlay.service||
			Components.classes["@userstyles.org/style;1"].getService(Components.interfaces.stylishStyle)
		synchRemoveButton()
		
	}catch(e){}
	
	synchMode()
	resetVals()
}
resetVals=function(){
	barHeight=aWin.gURLBar.getBoundingClientRect().height-2
	
	var st=aWin.getComputedStyle(aWin.gURLBar.inputField,"")
	fontSize= parseInt(st.fontSize)
	
	var d=aWin.document.createElement("div")
	d.textContent="5"
	d.style.position='fixed'
	d.style.fontSize=''+fontSize;
	aWin.gURLBar.appendChild(d)
	lineHeight=d.boxObject.height
	aWin.gURLBar.removeChild(d)	
	
	padding=(barHeight-lineHeight)/2;
	if(padding-Math.floor(padding)>0){
		lineHeight--;
		padding=(barHeight-lineHeight)/2;
	}
	document.getElementById("bar-height").value = barHeight;
	document.getElementById("font-size").value = fontSize;	
}

updateParamValues=function(aWin){
	barHeight=parseInt(document.getElementById("bar-height").value);
	fontSize=parseInt(document.getElementById("font-size").value);	
	hideAnnoyance=document.getElementById("annoyance").checked
	fissionBackground=document.getElementById("fission").checked
	
	var d=aWin.document.createElement("div")
	d.textContent="5"
	d.style.position='fixed'
	d.style.fontSize=''+fontSize;
	aWin.gURLBar.appendChild(d)

	lineHeight=d.boxObject.height
	aWin.gURLBar.removeChild(d)	
	
	padding=(barHeight-lineHeight)/2;
	if(padding-Math.floor(padding)>0){
		lineHeight--;
		padding=(barHeight-lineHeight)/2;
	}
}
bindingce='url("chrome://smarttext/content/ce/urlbar.xml#urlbar")'
binding2='url("chrome://smarttext/content/urlbar.xml#urlbar")'
synchMode=function(){
	if(!stylishService){
		document.getElementById('switch-to-stylish').setAttribute('disabled',true)
	}else document.getElementById('switch-to-stylish').removeAttribute('disabled')
	var asheet=findStylesheet(aWin,stylePath)
	if(!stylishService||(asheet&&asheet.cssRules.length!=0)){
		binding=bindingce
		mode='normal'
		document.getElementById('stylish').style.display='none'
	    document.getElementById('normal').style.display=''
		return
	}	
	binding=binding2
	mode='stylish'
	document.getElementById('stylish').style.display=''
	document.getElementById('normal').style.display='none'
}

reset=false
prepareStyle=function(){
	gChange=true

	updateParamValues(aWin);

var styleBits={mainRule :
'/**==technical stuff==**/\n\
#urlbar {\n\
  '+(
  binding==bindingce?'-moz-binding: url("chrome://smarttext/content/ce/urlbar.xml#urlbar")':
  '-moz-binding: url("chrome://smarttext/content/urlbar.xml#urlbar")')
  +' !important;\n\
}\n\
\n\
.smart-text>scrollbar {display:none!important}\n\
\n\
stsegment{\n\
    -moz-user-focus: normal;\n\
    -moz-user-select: text;\n\
    white-space: pre;\n\
    display:block;\n\
}\n\
.smart-text{\n\
   -moz-user-select: text;\n\
   color:graytext;\n  '+(mode=='stylish'?'':'padding-left:1px\n')+
'}\n\
\n\
/**==top bottom==**/\n\
.top>stsegment:hover{\n\
   text-decoration: underline!important;\n\
}\n\
.smart-text.top{\n\
   cursor:pointer;\n\
}\n\
.smart-text-input.top{\n\
   cursor:alias;\n\
}\n\
/**==colors==**/\n\
stsegment:hover{\n\
   color: #1A1A1A!important;\n\
}\n\
.top>stsegment.subdomain:hover{\n\
   text-decoration: line-through!important;\n\
   color: darkblue!important;\n\
}\n\
stsegment.empty:hover{\n\
   text-decoration: none!important;\n\
   color:black!important;\n\
}\n\
stsegment.basedomain{color:black!important;}\n\
stsegment.querry{color:#717171}\n\
.smart-text-ellipsis:hover{\n\
   text-shadow:-1px -1px 2px;\n\
   color:blue\n\
}\n\
.smart-text.left:hover{\n\
   color: #1A1A1A!important;\n\
}\n\
\n\
'
	,sizeRule:
'/**==sizes==**/\n\
stsegment'+(mode=='stylish'?',.smart-text-input>div.anonymous-div':'')+'{\n\
   padding:'+padding+'px 0px;\n\
   line-height:'+lineHeight+'px;\n\
}\n\
\n\
.smart-text-input,.urlbarAll {\n\
  min-height:'+barHeight+'px;\n\
  font-size:'+fontSize+'px!important;\n\
}\n\
\n\
'
    ,sizeRule2:
'.urlbarAll {\n\
  margin-left:3px!important;\n\
}\n\
'
	,containerRule:
'@-moz-document url("chrome://browser/content/browser.xul"){\n\
\n\
$content$\n\
}'
	,annoyingLabelRule:
'#identity-icon-label{\n\
  display:none\n\
}'

	,fissionBackground:
'#urlbar progressmeter>.progress-bar {\n\
   background:none!important;\n\
   margin: 0 -18px -5px -6px !important;\n\
  -moz-border-image: url("data:image/png;base64,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") 0 10 8 50 / 0 10px 8px 50px !important;\n\
}'
}

	
	styleCode=styleBits.mainRule
	if(!reset)
		styleCode+=styleBits.sizeRule
	styleCode+=styleBits.sizeRule2
	if(!reset&&hideAnnoyance)
		styleCode+=styleBits.annoyingLabelRule;
	if(!reset&&fissionBackground)
		styleCode+=styleBits.fissionBackground;
	
	styleCode=styleBits.containerRule.replace("$content$",styleCode);	
	
	if(reset){resetVals();reset=false}
	
	return styleCode
}


/**option win*/
alertPanel=function(title,message,alerter){
	var panel=document.getElementById("alertpanel");
	var titlebox=document.getElementById("alert-p-title");
	var textbox =document.getElementById("alert-p-text");
	var but1 =document.getElementById("alert-p-1");
	var but2 =document.getElementById("alert-p-2");
	
	titlebox.value=title;
	textbox.value=message;
	but1.onclick=function(){textbox.select()}
	but2.onclick=function(){
		const gClipboardHelper = Components.classes["@mozilla.org/widget/clipboardhelper;1"].  
				getService(Components.interfaces.nsIClipboardHelper);  
		gClipboardHelper.copyString(textbox.value);  
		textbox.select();
	}
	//var bo=alerter.boxObject
	//panel.showPopup(alerter,bo.screenX, bo.screenY+bo.height, 'popup')
	panel.openPopup(alerter, "after_start", 0, 0, false, false);
}

reloadWin=function(silent){
	if(window.opener.document){
		window.opener.openDialog(styleURI,'','top='+screenY+',left='+screenX);
		window.close()
		return;
	}
	document.location=document.location;	
}
/**stylish*/
removeStylihStyle=function(silent){
	try{		
		var uri = styleURI;
		var style = aWin.stylishOverlay.service.findByUrl(uri,1)
		style.delete()
		if(!silent)alertPanel('"style for smart-text" successfully removed',/*"neet isn't it?:)"*/'',document.getElementById("stylish"))
	}catch(e){
		if(!silent)alertPanel('seems "style for smart-text"' ,'was already removed',document.getElementById("stylish"))
	}
}

createStylihStyle=function(type){
	binding=binding2
	var styleCode=prepareStyle()
	if(type=="compute"){
		alertPanel('the style you chose :)',styleCode,document.getElementById("calculatebutton"));
		return
	}

		var uri = styleURI;
		var style = stylishService.findByUrl(uri,1)
		if(!style){
			style = Components.classes["@userstyles.org/style;1"].createInstance(Components.interfaces.stylishStyle);
			style.mode = style.CALCULATE_META | style.REGISTER_STYLE_ON_CHANGE;
			style.init(uri, uri, null, "style for smart-text", styleCode, false, "");
		}
		style.enabled=false
		style.code=styleCode;
		style.setPreview(false);
		style.enabled=true
		style.save()
		//notify user
		alertPanel('"style for smart-text" successfully installed',/*"neet isn't it?:)"*/'',document.getElementById("installbutton"))
		//clear first run info


	synchRemoveButton()
}


saveStylihStyle=function(){
	
		var uri = styleURI;
		var style = stylishService.findByUrl(uri,1)
		if(!style){
			style = Components.classes["@userstyles.org/style;1"].createInstance(Components.interfaces.stylishStyle);
			style.mode = style.CALCULATE_META | style.REGISTER_STYLE_ON_CHANGE;
			style.init(uri, uri, null, "style for smart-text", styleCode, false, "");
		}
		style.enabled=false
		style.code=styleCode;
		style.setPreview(false);
		style.enabled=true
		style.save()
		//notify user
		//alertPanel('"style for smart-text" successfully installed',/*"neet isn't it?:)"*/'',document.getElementById("installbutton"))
	
}



synchRemoveButton=function(style){return
	if(typeof style=='undefined')try{
		style = stylishService.findByUrl(styleURI,1)
	}catch(e){}
	var elem=document.getElementById("uninstallbutton").style
	if(style){
		elem.display=''
	}else
		elem.display='none'
}

/**css file*/
/** ---------------------------------------**\
 | Basic Directory IO object based on JSLib |
 | source code found at jslib.mozdev.org    |
\**----------------------------------------**/
var FileIO ={
	localfileCID:  '@mozilla.org/file/local;1',
	localfileIID:  Components.interfaces.nsILocalFile,

	finstreamCID:  '@mozilla.org/network/file-input-stream;1',
	finstreamIID:  Components.interfaces.nsIFileInputStream,

	foutstreamCID: '@mozilla.org/network/file-output-stream;1',
	foutstreamIID: Components.interfaces.nsIFileOutputStream,

	sinstreamCID:  '@mozilla.org/scriptableinputstream;1',
	sinstreamIID:  Components.interfaces.nsIScriptableInputStream,

	suniconvCID:   '@mozilla.org/intl/scriptableunicodeconverter',
	suniconvIID:    Components.interfaces.nsIScriptableUnicodeConverter,

	open: function(path){
		try{
			var file = Components.classes[this.localfileCID].createInstance(this.localfileIID);
			file.initWithPath(path);
			return file;
		}
		catch(e){
			return false;
		}
	},
	read: function(file, charset){
		try{
			var data = new String();
			var fiStream = Components.classes[this.finstreamCID].createInstance(this.finstreamIID);
			var siStream = Components.classes[this.sinstreamCID].createInstance(this.sinstreamIID);
			fiStream.init(file, 1, 0, false);
			siStream.init(fiStream);
			data += siStream.read(-1);
			siStream.close();
			fiStream.close();
			if (charset){
				data = this.toUnicode(charset, data);
			}
			return data;
		} 
		catch(e){
			return false;
		}
	},

	write: function(file, data, mode, charset){
		try{
			var foStream = Components.classes[this.foutstreamCID].createInstance(this.foutstreamIID);
			if (charset){
				data = this.fromUnicode(charset, data);
			}
			var flags = 0x02 | 0x08 | 0x20; // wronly | create | truncate
			if (mode == 'a'){
				flags = 0x02 | 0x10; // wronly | append
			}
			foStream.init(file, flags, 0664, 0);
			foStream.write(data, data.length);
			// foStream.flush();
			foStream.close();
			return true;
		}
		catch(e){
			return false;
		}
	},

	create: function(file){
		try{
			file.create(0x00, 0664);
			return true;
		}catch(e){
			return false;
		}
	},

	unlink: function(file){
		try{
			file.remove(false);
			return true;
		}catch(e){
			return false;
		}
	},

	path: function(file){
		try{
			return 'file:///' + file.path.replace(/\\/g, '\/').replace(/^\s*\/?/, '').replace(/\ /g, '%20');
		}
		catch(e){
			return false;
		}
	},

	toUnicode: function(charset, data){
		try{
			var uniConv = Components.classes[this.suniconvCID]
								.createInstance(this.suniconvIID);
			uniConv.charset = charset;
			data = uniConv.ConvertToUnicode(data);
		} 
		catch(e){
			// foobar!
		}
		return data;
	},

	fromUnicode: function(charset, data){
		try{
			var uniConv = Components.classes[this.suniconvCID]
								.createInstance(this.suniconvIID);
			uniConv.charset = charset;
			data = uniConv.ConvertFromUnicode(data);
			// data += uniConv.Finish();
		}
		catch(e){
			// foobar!
		}
		return data;
	},
	
	getWriteStream: function(file){
		var stream = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
		stream.init(file, 0x02 | 0x08 | 0x20, 420, -1);
		return stream;
	}

}

//

function chromeToPath (aPath) {
   if (!aPath || !(/^chrome:/.test(aPath)))
      return; //not a chrome url
   var rv;
   
      var ios = Components.classes['@mozilla.org/network/io-service;1'].getService(Components.interfaces["nsIIOService"]);
        var uri = ios.newURI(aPath, "UTF-8", null);
        var cr = Components.classes['@mozilla.org/chrome/chrome-registry;1'].getService(Components.interfaces["nsIChromeRegistry"]);
        rv = cr.convertChromeURL(uri).spec;

        if (/^file:/.test(rv))
          rv = this.urlToPath(rv);
        else
          rv = this.urlToPath("file://"+rv);

      return rv;
}

function urlToPath (aPath) {

    if (!aPath || !/^file:/.test(aPath))
      return ;
    var rv;
   var ph = Components.classes["@mozilla.org/network/protocol;1?name=file"]
        .createInstance(Components.interfaces.nsIFileProtocolHandler);
    rv = ph.getFileFromURLSpec(aPath).path;
    return rv;
}

var writeToFile = function(file,srcText){
    if(!FileIO.write(destFile, srcText))   {
       throw Error("Failed to copy " + srcFile.path + " to " + destFile.path);
    }
};

saveStylesheetFile=function(text){	
	try{
		var fileurl = chromeToPath(stylePath);
		var file1 = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
		file1.initWithPath(fileurl);
		
		FileIO.write(file1,text)
	}catch(e){alert("unable to copy files, please report the bug")}
}

stylePath='chrome://smarttext/content/ce/urlbar.css'
findStylesheet=function(awin,href){
  var ss = awin.document.styleSheets;
    for (var i = ss.length - 1; i >= 0; i--){
      var ahref=ss[i].href
      if (ahref&& ahref.indexOf(href)>-1) 
        return ss[i]    
    }
}

apllyStylesheet1=function(styleCode){	
	if(typeof styleCode=='undefined'){
		binding=bindingce
		styleCode=prepareStyle()
	}
	var pi=document.getElementById('pi')
	if(! pi){
		pi=document.createElementNS('http://www.w3.org/1999/xhtml','style')
		pi.id='pi'		
		document.documentElement.appendChild(pi)
	}
	pi.textContent=styleCode
	newStylesheet=pi.sheet

	//apply stylesheet changes to all windows
	newStyles=newStylesheet.cssRules
	fWins = winService.getEnumerator('navigator:browser');
	while(fWins.hasMoreElements()){
		activeStylesheet=findStylesheet(fWins.getNext(),stylePath)
		n=activeStylesheet.cssRules.length
		//clear
		for(var i=0;i<n;++i)
			activeStylesheet.deleteRule(0)
		//copy		
		n=newStyles.length
		for(var i=0;i<n;++i)
			activeStylesheet.insertRule(newStyles[i].cssText,i)
	}
}

findCurrentStylesheet=function(win){
	document.getElementById("skin")
	activeStylesheet=findStylesheet(win,chromeSkinDir)
	l=activeStylesheet.cssRules.length
	for(var i =0;i<stylelengths.length;++i){
		if(stylelengths[i][0]==l)
		break
	}
	document.getElementById("skin").selectedIndex=i
}


switchtoStylish=function(){		
	binding=binding2
	mode='stylish'
	try{
		createStylihStyle('install')
	}catch(e){	
		synchMode();
		return
	}	
	apllyStylesheet1('')
	saveStylesheetFile('')
	synchMode()
	gChange=false
}
switchtoNormal=function(){	
	mode='normal'
	binding=bindingce
	apllyStylesheet1()
	saveStylesheetFile(styleCode)
	removeStylihStyle('silent')
	
	synchMode()
	gChange=false
}

findStylishStyleSheet=function(element,descriptiveCss){
	var domUtils=Components.classes["@mozilla.org/inspector/dom-utils;1"].getService(Components.interfaces.inIDOMUtils)
	var inspectedRules=domUtils.getCSSStyleRules(element)
	for (var i = 0; i < inspectedRules.Count(); ++i){
		var rule = inspectedRules.GetElementAt(i) 
		if(rule.cssText.indexOf(binding2)>0||rule.cssText.indexOf(bindingce)>0){
			var s=rule.parentStyleSheet
			return s
		}
	}
}
stylishStylesheetCache=''
apllyStylesheet2=function(styleCode){	
	if(typeof styleCode=='undefined'){
		binding=binding2
		styleCode=prepareStyle()
	}
		
	var pi=document.getElementById('pi')
	if(! pi){
		pi=document.createElementNS('http://www.w3.org/1999/xhtml','style')
		pi.id='pi'		
		document.documentElement.appendChild(pi)
	}
	pi.textContent=styleCode
	newStylesheet=pi.sheet

	//apply stylesheet changes to all windows
	newStyles=newStylesheet.cssRules
	
	activeStylesheet=stylishStylesheetCache=
			stylishStylesheetCache||findStylishStyleSheet(aWin.gURLBar,binding2)
	n=activeStylesheet.cssRules.length
	//clear
	for(var i=0;i<n;++i)
		activeStylesheet.deleteRule(0)
	//copy		
	n=newStyles.length
	for(var i=0;i<n;++i)
		activeStylesheet.insertRule(newStyles[i].cssText,i)	
	
		
	//force reflow
	fWins = winService.getEnumerator('navigator:browser');
	while(fWins.hasMoreElements()){
		var win1=fWins.getNext().gURLBar.style//document.documentElement.style//
		win1.display='none'
		win1.display=''
	}
}

applyStyleSheet =function(){
	if(mode=='stylish'){
		apllyStylesheet2()
	}else if(mode=='normal'){
		apllyStylesheet1()
	}
}
save =function(){
	if(mode=='stylish'){
		saveStylihStyle(styleCode)
	}else if(mode=='normal'){
		saveStylesheetFile(styleCode)
	}
}
saveChanges=function(){if(gChange)save()}

/***/
'#identity-icon-label'
findRuleInStyleSheet=function(styleSheet,selector){	
	function=findRuleInCSSRules(cssRules){
		for(var i=0;i<cssRules.length;i++){
			let rule=cssRules[i]
			if(rule.type===1){				
				if(rule.selectorText.indexOf(text)>-1) return rule				
			}else if(rule.cssRules){
				rule=findRuleInCSSRules(rule.cssRules)
				if(rule) return rule
			}
		}
		return;
	}
	findRuleInCSSRules(styleSheet,cssRules)
}
 ]]>
</script>






</window>